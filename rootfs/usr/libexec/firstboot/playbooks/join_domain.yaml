---
- name: Joing Domain
  hosts: localhost
  vars:
    vault_server: ${VAULT_SERVER}
  tasks:
    - name: Get common secrets
      community.hashi_vault.vault_kv2_get:
        url: {{ vault_server }}
        auth_method: approle
        role_id: "{{ lookup('ansible.builtin.file', '/usr/lib/vault/role_id') }}"
        secret_id: "{{ lookup('ansible.builtin.file', '/etc/vault/secret_id') }}"
        path: "secrets/immutable-os/common"
      register: domain_info

    - name: Write SSSD config
      ansible.builtin.template:
        src: templates/sssd.conf.j2
        dest: /etc/sssd/conf.d/{{ domain }}.conf
        owner: root
        group: root
        mode: '0400'
      notify:
        - Reload SSSD

    - name: Write Certificate
      ansible.builtin.copy:
        content: "{{ domain_info.domain_certificate }}"
        dest: /etc/sssd/pki/sssd_auth_ca_db.pem
      notify:
        - Trust Certificate

    - name: 'KRB5.conf: set dns_lookup_realm'
      ansible.builtin.lineinfile:
        path: /etc/krb5.conf
        regexp: '^#?\s*dns_lookup_realm\s*='
        line: 'dns_lookup_realm = true'

    - name: 'KRB5.conf: set dns_lookup_kdc'
      ansible.builtin.lineinfile:
        path: /etc/krb5.conf
        regexp: '^#?\s*dns_lookup_kdc\s*='
        line: 'dns_lookup_kdc = true'

    - name: 'KRB5.conf: set rdns'
      ansible.builtin.lineinfile:
        path: /etc/krb5.conf
        regexp: '^#?\s*rdns\s*='
        line: 'rdns = true'

    - name: 'KRB5.conf: set default_realm'
      ansible.builtin.lineinfile:
        path: /etc/krb5.conf
        regexp: '^#?\s*default_realm\s*='
        line: "default_realm = {{ domain_info.domain }}"

    - name: Domain Join
      ansible.builtin.command: |
        source /etc/os-release; /usr/sbin/adcli join -U <join_user> --os-name="${NAME}" \
        --os-version="${VERSION}" --os-service-pack="${VERSION_ID}"

  handlers:
    - name: Reload SSSD
      ansible.builtin.service:
        name: sssd
        state: restarted

    - name: Trust Certificate
      ansible.builtin.command: /usr/bin/trust anchor /etc/sssd/pki/sssd_auth_ca_db.pem